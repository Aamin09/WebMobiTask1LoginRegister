@model IEnumerable<Task1LoginRegister.DTOs.ProductPerformanceDto>
@{
    ViewData["Title"] = "ProductPerformance";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<style>
    /* Ensure charts have proper dimensions for PDF export */
    canvas {
        max-width: 100% !important;
        height: auto !important;
    }

    /* Printable area styling */
    #printableArea {
        background: white;
        padding: 20px;
    }

    @@media print {
        body * {
            visibility: hidden;
        }

        #printableArea, #printableArea * {
            visibility: visible;
        }

        #printableArea {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
    }

</style>

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-box me-2"></i> Product Performance</h2>
        <div>
            <a asp-action="Index" asp-controller="Report" class="btn btn-sm btn-outline-secondary"><i class="fas fa-arrow-left"></i> Back to Report</a>
            
            <button class="btn btn-sm btn-outline-success" onclick="exportToPDF()">
                <i class="fas fa-file-pdf me-1"></i> Export PDF
            </button>
        </div>
    </div>
    <!-- date filters -->
    <partial name="_DateApplyFilters" />

    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="mb-0 fw-bold text-primary">Top Products by Revenue</h6>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" width="100%" height="50"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="mb-0 fw-bold text-primary">Top Products by Quantity Sold</h6>
                </div>
                <div class="card-body">
                    <canvas id="quantityChart" width="100%" height="50"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4" id="printableArea">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Product Performance Report</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive" >
                <table class="table table-bordered table-striped table-hover" id="productTable" width="100%" cellspacing="0">
                    <thead class="bg-primary text-white">
                        <tr>
                            <th>Product Name</th>
                            <th>Quantity Sold</th>
                            <th>Total Revenue (₹)</th>
                            <th>Orders</th>
                            <th>Avg. Order Value (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var product in Model)
                        {
                            <tr>
                                <td>@product.ProductName</td>
                                <td>@product.TotalQuantitySold</td>
                                <td class="text-end">@product.TotalRevenue.ToString("N2")</td>
                                <td>@product.OrderCount</td>
                                <td class="text-end">@product.AverageOrderValue.ToString("N2")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script>
            $(document).ready(function () {
            // Initialize DataTable for the table
            $('#productTable').DataTable({
                destroy: true // Allows destroying the table instance
            });

            // Prepare chart data
            var products = @Html.Raw(Json.Serialize(Model.Take(5).Select(p => p.ProductName).ToList()));
            var revenues = @Html.Raw(Json.Serialize(Model.Take(5).Select(p => p.TotalRevenue).ToList()));
            var quantities = @Html.Raw(Json.Serialize(Model.Take(5).Select(p => p.TotalQuantitySold).ToList()));

            // Revenue Chart
            new Chart(document.getElementById('revenueChart'), {
                type: 'bar',
                data: {
                    labels: products,
                    datasets: [{
                        data: revenues,
                        backgroundColor: 'rgba(78, 115, 223, 0.8)'
                    }]
                },
                options: {
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => '₹' + value.toLocaleString()
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => '₹' + value.toLocaleString()
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Quantity Chart
            new Chart(document.getElementById('quantityChart'), {
                type: 'bar',
                data: {
                    labels: products,
                    datasets: [{
                        data: quantities,
                        backgroundColor: 'rgba(28, 200, 138, 0.8)'
                    }]
                },
                options: {
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'top'
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        });

        // Function to destroy DataTable before PDF and reinitialize it after
        function destroyDataTable() {
            if ($.fn.DataTable.isDataTable('#productTable')) {
                $('#productTable').DataTable().destroy();
            }
        }

        // Reinitialize DataTable after export
        function reinitializeDataTable() {
            $('#productTable').DataTable({
                destroy: true
            });
        }

        // Export PDF without DataTable styles
        function exportToPDF() {
            destroyDataTable(); // Destroy DataTable for plain table export

            const btn = document.querySelector('[onclick="exportToPDF()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            btn.disabled = true;

            setTimeout(() => {
                const element = document.getElementById('printableArea');
                const { jsPDF } = window.jspdf;

                html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                    pdf.setFontSize(16);
                    pdf.setTextColor(40);
                    pdf.text('Product Performance Report', pdfWidth / 2, 15, { align: 'center' });
                    pdf.addImage(imgData, 'PNG', 0, 25, pdfWidth, pdfHeight - 25);
                    pdf.save(`Product_Performance_Report.pdf`);
                }).catch(err => {
                    console.error('Error generating PDF:', err);
                    alert('Error generating PDF. Please try again.');
                }).finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    reinitializeDataTable(); // Reinitialize DataTable after export
                });
            }, 500); // Delay to ensure rendering is done
        }

    </script>
}